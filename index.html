<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>World Bank Global Development Sprint</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>
    <!-- https://dl-web.dropbox.com/spa/6x4vg7uwuzglgh3/wbgds/public/index.html -->
<body>

<!-- ********************************************************************* version code begins ** -->
<!--<script src="http://use.edgefonts.net/lato.js"></script>-->
<!--<script charset="utf-8" src="http://d3js.org/d3.v3.min.js"></script>-->
<script charset="utf-8" src="http://d3js.org/d3.v3.js"></script>
<script charset="utf-8" src="https://rawgithub.com/artzub/d3-plugins/master/sankey/sankey.js"></script>
<!--<script charset="utf-8" src="sankey.js"></script>-->

<style>

    html, body {
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
    }

    body {
        font-family: serif;
        font-size: 11px;

        background: url('data:image/png;base64,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');
    }

    #chart, #sidebar {
        float: left;
        height: 100%;
        position: relative;
        overflow: hidden;
        background: linear-gradient(to bottom, rgba(255,255,255,.1) 0%,rgba(255,255,255,.01) 100%);
    }

    #chart {
        /*width: -webkit-calc(100% - 215px);
        width: calc(100% - 215px);*/
        width: 100%;
    }

    #sidebar {
        padding-left: 5px;
        width: 210px;
        box-shadow: -1px 0 6px 1px rgba(0, 0, 0, .2);
        background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,.1) 100%);
    }

    #sidebar a {
        display: block;
        margin-top: -18px;
        margin-bottom: 5px;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: none;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-size: 9px;
        fill: #999;
        color: #999;
    }

    .axis .major line {
        stroke: #ddd;
    }

    .y.axis .major line {
        stroke-opacity: .2;
    }

    .title{
        font-size: 1.5em;
    }

    .dot:hover, .legend:hover {
        cursor: pointer;
    }

    .dot circle {
        stroke-width : .5;
    }

    .dotName text {
        color: #888;
        font-weight: bold;
        text-shadow: 0 -2px 3px rgba(255, 255, 255, 1);
    }

    .tooltip {
        padding: .5em;
        background: #fff;
        border: 1px solid #eee;
        width: 150px;
        line-height: 1.5em;
        box-shadow: 0 0 8px rgba(0, 0, 0, .5);
    }

    .group text {
        font: 11px sans-serif;
        pointer-events: none;
    }

    .group path {
        stroke: #000;
    }

    .chord path {
        stroke-width: .75;
        fill-opacity: .75;
    }

    .chord.unselect path {
        fill-opacity: .05;
    }

    .sankey .node {
        cursor: move;
    }

    .sankey .node rect {
        fill-opacity: .9;
        shape-rendering: crispEdges;
    }

    .sankey .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
    }

    .sankey .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .3;
    }

    .filters {
        position: relative;
        width: 100%;
    }

    #filters ul {
        padding: 0;
        margin: 0;
        width: 100%;
        overflow: hidden;
        list-style: none;
        position: relative;
        font-size: 12px;
    }

    ul li {
        position: relative;
        vertical-align: middle;
        white-space: nowrap;
    }

    #filters #vis_type {
        position: absolute;
        bottom: 0;
    }

    li * {
        display: inline-block;
        z-index: 2;
    }

    li .crcl {
        border-radius: .5em;
        padding: .5em;
        background: #000;
        margin: .15em 5px -.15em .05em;
    }

    .legend {
        text-shadow: 0 1px 2px rgba(255, 255, 255, .8);
    }

    .legend .bg {
        opacity: 0;
        z-index: 0;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        position: absolute;
    }

    .legend:hover .bg,
    .legend.checked:hover .bg {
        opacity: .2;
    }

    .legend:active .bg,
    .legend.checked:active .bg {
        opacity: .6;
    }

    .legend.checked .bg {
        opacity: .4;
    }

    #filter_cond {
        max-height: 200px;
        overflow-y: auto !important;
    }

</style>


<div id="chart"></div>
<div id="sidebar">
    <h1>Distribution of<br/>Grant Awards in<br/>Fiscal Year 2013</h1>
    <a href="http://visualizing.org/sprint/launch/" id="oinw" title="fullscreen version" target="_blank">Open in a new window</a>
    <div id="filters">
        <div style="opacity: .2">Click on items in order to apply filters</div>
        <ul id="filter_cond"></ul>
        <ul id="param_type"><li><strong>Group by:</strong></li></ul>
        <ul id="from_to_type"><li><strong>Based on:</h1></strong></ul>
        <ul id="vis_type"></ul>
    </div>
</div>


<script>


"use strict";

/**
 * Vars, Scales, Axies
 */

// ISO metrics for number, but based on current data
var ISO = {
    M : Math.pow(10, 3),
    B : Math.pow(10, 6),
    T : Math.pow(10, 9)
};

var mode = {
        Particles : 0,
        Packages : 1,
        Chords : 2,
        Sankeys : 3
    },
    modeParam = {
        "Sector" : "Major Sector",
        "Procurement Category" : "Procurement Category",
        "Procurement Method" : "Procurement Method",
        "Procurement Type" : "Procurement Type",
        "Product line" : "Product line"
    },
    modeBase = {
        Borrower : "borrower",
        Supplier : "supplier"
    }
    ;

d3.select("#oinw").attr("href", document.location);

var vis = initVis();

// Number Formatting
var th = d3.format(",");

var sidebar = d3.select("#sidebar")
        , sb_w =  sidebar.node().clientWidth || 215
        , chart = d3.select("#chart")
        , widthFull = (chart.node().clientWidth || 740) - sb_w
        , heightFull = chart.node().clientHeight || 600
// TODO: left margin should calculate based on country name
        , margin = {top: 10, right: 20, bottom: 20, left: 140}
        , width = widthFull - margin.left - margin.right
        , height = heightFull - margin.top - margin.bottom
        ;
chart.style("width", widthFull + "px");

var root, zfn, dfn
    , countryPoints, countryNames, country
    , currentModeParam, currentModeBase, currentMode
    ;

// The pack layout, for computing the radius of groups.
var pack =  d3.layout.pack()
        .children(function(d) {
            return d.values;
        })
        .padding(2)
        .size([width + margin.left, height]);

// The chord layout, for computing the angles of chords and groups.
var chord = d3.layout.chord()
        //.sortGroups(undefined)
        //.sortSubgroups(d3.descending)
        //.sortChords(d3.descending)
        .padding(.01);

// Y Scale for Contract Amount
var x = d3.scale.log()
        .range([margin.top, width]);

// Order Countries on X
var y = d3.scale.ordinal()
        .rangeRoundBands([margin.top/2, height]);

var yAxis = d3.svg.axis()
        .scale(y)
        .tickSize(-width)
        .orient("left");

function xAxisFormat(d) {
    if (d < ISO.M)
        d = d + "M";
    else if (d < ISO.B)
        d = (d / ISO.M) + "B";
    else if (d < ISO.T)
        d = (d / ISO.B) + "T";
    else
        d = th(d);
    return d;
}

var xAxis = d3.svg.axis()
        .scale(x)
        .tickSize(-height)
        .ticks(12, xAxisFormat)
        .orient("bottom");

var circleArc = d3.svg.arc()
        .startAngle(0)
        .endAngle(Math.PI * 2)
        .innerRadius(0)
        .outerRadius(radius);

function toRgba(c, a, fn) {
    c = d3.rgb(c.toString().replace("rgba", "rgb"));
    c = fn ? c[fn]() : c;
    return "rgba(" + [c.r, c.g, c.b, a] + ")";
}

function fill(d) {
    return d.type == -1
        ? "none"
        : toRgba(d.type
            ? (d.type == 2
                ? vis.color(d.key)
                : "rgba(236, 246, 255)")
            : vis.color(d[currentModeParam]), .5
        );
}

function stroke(d) {
    return d.type == -1 || !currentMode ? "none" : toRgba(fill(d), .7, "darker");
}

function visibility(d) {
    return x(d.value) > 0 || currentMode ? null : "hidden";
}

function displayLength(node) {
    return node.clientWidth
            || (node.getComputedTextLength ? node.getComputedTextLength() : node.innerText.length);
}

function visName(d) {
    var g = d3.select(this);
    return currentMode && displayLength(g.select("text").node()) < d.r * 1.8 ? null : "hidden";
}

function radius(d) {
    return !currentMode
            ? !d.values
            ? 3.5
            : 0
            : d.r;
}

function value(d) {
    return d.basevalue;
}

function key(d) {
    return (d[currentModeBase] && d[currentModeBase].shortName) || "";
}

function yPos(d) {
    return !currentMode ? y(key(d)) : d.y;
}

function xPos(d) {
    return !currentMode ? x(value(d)) : d.x;
}

// Zooming axes
// http://bl.ocks.org/mbostock/3892928
function pos(d) {
    return "translate(" + [xPos(d), yPos(d)] + ")";
}

// default transform for packages
zfn = {s:1, t : [0,0]};

// default transform fo particles
dfn = {s : 1, t : [margin.left , margin.top/2]};

function zoomed(tr) {
    transform(tr);

    svg.attr("transform", "translate(" + (currentMode ? [0, 0] : dfn.t) + ")");

    if (currentMode == mode.Particles)
        svg.selectAll(".x.axis")
            .call(xAxis.ticks(12, xAxisFormat));

    svg.selectAll(".y.axis, .x.axis")
            .style("display", currentMode ? "none" : null);

    countryNames.attr("transform", pos)
        .style("visibility", visName)
    ;

    (!tr
        ? countryPoints
        : countryPoints.transition().delay(375).duration(1500)
    ).attr("transform", pos)
            .style("visibility", visibility)
            .selectAll("path")
            .style({
                "fill" : fill,
                "stroke" : stroke
            })
            .attr("d", circleArc)
    ;
}

function correctTranslate(d, s) {
    s = s || 1;
    return [d[0]/s, d[1]/s];
}

function transform(tr) {
    if (currentMode && d3.event && d3.event.translate) {
        zfn.s = d3.event.scale;
        zfn.t = correctTranslate(d3.event.translate, zfn.s)
    }

    (!tr ? country : country.transition().duration(1500))
            .attr("transform", "scale(" +
                    (currentMode ? zfn : dfn).s  +
                    ")translate(" +
                    (currentMode ? zfn.t : [0,0]) +
                    ")");
}

var zoom = d3.behavior.zoom()
        .x(x)
        .translate([-margin.left, 0])
        .on("zoom", zoomed)
        .scaleExtent([Math.E / 100, Math.E])
        .scale(.15)
    , zoomPack = d3.behavior.zoom()
        .on("zoom", transform)
        .scaleExtent([1, 20])
    , clearZoom = d3.behavior.zoom()
    ;

/**
 * Draw Frame
 */

var svg = chart.append("svg")
                .attr("width", widthFull)
                .attr("height", heightFull)
                .append("g")
                .attr("transform", "translate(" + dfn.t + ")")
                .call(zoom)
        , zl = svg.append("rect")
                .attr("width", widthFull)
                .attr("height", heightFull)
                .style("opacity", 0)
        ;

function initRootValues(data) {
    vis.chord.hide().clear();
    vis.sankey.hide().clear();
    return d3.nest()
        .key(function(d) {
            return d[currentModeBase].shortName;
        })
        .key(function(d) {
            vis.color(d[currentModeParam]);
            return d[currentModeParam];
        })
        .entries(data.sort(function(a, b) {
            if (!a.supplier)
                a = vis.dataItem(a);

            if (!b.supplier)
                b = vis.dataItem(b);

            return d3.ascending(a[currentModeBase].shortName, b[currentModeBase].shortName);
        }))
        .filter(function(d){
            d.type = 1;

            var t = /*d.values.reduce(function(a, b) {
             b.type = 2;
             return a + b.values.length;
             }, 0) > 15*/true;

            t && d.values.forEach(function(b) {
                b.type = 2;
                vis.chord.initMatrix(b.values);
                vis.sankey.initLinks(b.values);
            });
            return t;
        })
    ;
}

function applyMode() {
    zoomed(arguments.length ? arguments[0] : undefined);

    if (currentMode == mode.Chords) {
        vis.sankey.hide();
        vis.chord.show().draw(svg, chord, width + margin.left, height);
    }
    else if (currentMode == mode.Sankeys) {
        vis.chord.hide();
        vis.sankey.show().draw(svg, null, width + margin.left, height);
    }
    else {
        vis.sankey.hide();
        vis.chord.hide();
    }
}

// Load the data from 2013
//d3.csv("/sites/default/files/data_set/admin/sprint_major-contract-awards-2013.csv", function(error, data) {
d3.csv("sprint_major-contract-awards-2013.csv", function(error, data) {

    currentModeParam = modeParam.Sector;
    currentModeBase = modeBase.Borrower;

    function getAll(a, b) {
        return a.concat(b.values);
    }

    function sort(a, b) {
        return a.value - b.value;
    }

    // Nest Borrower Countries into a new Array
    root = {
        key:"",
        type : -1,
        values: initRootValues(data)
    };

    pack.sort(sort).value(value);

    x.domain(d3.extent(data, value)).nice();
    y.domain(root.values.map(function(d) { return d.key; }));

    svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height + 10) + ")")
            .call(xAxis)
            .append("text")
            .attr("class", "label")
            .attr("dx", width + margin.right/2)
            .attr("dy", -10)
            .style("fill", "#666")
            .style("text-anchor", "end")
            .text("Total Contract Amount (USD)")
    ;

    function fade(opt) {
        return function(d) {
            countryPoints.filter(function(k) {
                return k.type || k[currentModeBase].shortName != d;
            })
            .transition()
            .style("opacity", opt);
        }
    }

    function fadeDot(opt) {
        return function(d) {
            if (currentMode == mode.Packages)
                return;
            countryPoints.filter(function(k) {
                return k[currentModeBase] != d[currentModeBase];
            })
            .transition()
            .style("opacity", opt);
        }
    }

    svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .selectAll("text")
            .on("mouseover", fade(.1))
            .on("mouseout", fade(1))
            .attr("dy", '-.6em')
            .style("cursor", "pointer")
            .style("text-anchor", "end")
            .style("font-size", "8px")
    ;

    // Label for the Filtered Country or Sector.
    var title = svg.append("g")
                    .append("text")
                    .attr("class", "title")
                    .attr("x", width/2)
                    .attr("y", height - 25)
                    .attr("dy", 25)
                    .style("text-anchor", "middle")
                    .text("")
            ;

    /**
     * Draw Dots
     */

    vis.tooltip
        .spaceWidth(width)
        .spaceHeight(height)
    ;

    function pointKey(d) {
        return d.hasOwnProperty('key') ? (d.type == 2 ? d.type + d.key + d.parent.key : d.type + d.key)
            : d.id + d.contract.date + d.date;
    }

    country = svg.append("g");

    function initCountiesPoints(root) {
        countryPoints = country.selectAll(".dot")
            .data(pack.nodes(root), pointKey);

        countryPoints.exit().remove();

        countryPoints
            .enter()
            .append("g")
            .attr("class", "dot")
            .on("mouseover", fadeDot(.1))
            .on("mouseout", fadeDot(1))
            // Call tooltip helper to show information about the Contract
            .call(vis.tooltip)
            .append("path")
        ;

        countryPoints.each(function(k) {
            d3.select(this).selectAll("*")
                    .datum(k);
        });

        countryPoints.selectAll("path")
            /*.datum(function(d) {return d;})*/
            .style("fill", fill);

        countryNames = country
            .selectAll(".dotName")
            .data(countryPoints.data().filter(function(d) { return d.type == 1 }), pointKey);

        countryNames.exit().remove();

        countryNames
            .enter()
            .append("g")
            .attr("class", "dotName")
            .call(vis.tooltip)
            .append("text")
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(function(d) { return d.key.split(',')[0] })
        ;
    }
    initCountiesPoints(root);

    zoomed();

    /**
     * Add Legend
     */
    var hs = height - sidebar.select("h1").node().clientHeight,
        info = sidebar.select("#filters")
            .attr("height", hs)
        ;

    var filtersData = [{
        values : vis.color.domain().sort(),
        sclass : ".legend",
        idbox : "#filter_cond",
        c : vis.color,
        tr : function(d, i) { return "translate(0," + (i + 1) * 18 + ")"; },
        click : function(d) {
            var g = d3.select(this);
            if (g.classed("checked")) {
                g.classed("checked", false);
                vis.filterMap.remove(d);
            }
            else {
                g.classed("checked", true);
                vis.filterMap.set(d, true);
            }
            filterL(d);
        }
    }, {
        values : d3.keys(mode).reverse(),
        sclass : ".legend.itemType",
        idbox : "#vis_type",
        classes : function(d, i) { return "legend itemType" + (d == "Sankeys" ? " checked" : "");  },
        c : "#888",
        click : modeClick
    }, {
        values : d3.keys(modeParam),
        sclass : ".legend.fparam",
        idbox : "#param_type",
        classes : function(d, i) { return "legend fparam" + (d == "Sector" ? " checked" : "");  },
        c : "#B1F498",
        click : paramTypeClick
    }, {
        values : d3.keys(modeBase),
        sclass : ".legend.fftitem",
        idbox : "#from_to_type",
        classes : function(d, i) { return "legend fftitem" + (d == "Borrower" ? " checked" : "");  },
        c : "#C4E0F7",
        click : baseTypeClick
    }];

    function initFilters(item) {
        var legend = info.select(item.idbox).selectAll(item.sclass)
            .data(item.values, function(d) { return d; });

        legend.exit().remove();

        legend
            .enter()
            .append("li")
            .attr("class", item.classes || "legend")
            .on("click", item.click)
            .call(function(li) {
                li.attr("title", function(d) { return d; });

                li.append("span")
                    .attr("class", "bg")
                    .style("background", item.c)
                ;


                li.append("span")
                    .attr("class", "crcl")
                    .style("background", item.c)
                ;

                li.append("span")
                    .text(function(d) { return d; })
                ;
            })
        ;
    }

    function modeClick(d) {
        var g = d3.select(this);
        var tr = g.classed("checked");
        d3.select(this.parentNode)
                .selectAll(".itemType")
                .classed("checked", false);
        g.classed("checked", true);

        currentMode = mode[d];

        // save cur state
        if (currentMode != mode.Packages) {
            zfn.s = zoomPack.scale();
            zfn.t = correctTranslate(zoomPack.translate(), zfn.s);
        }

        // change zooming
        svg.call(currentMode == mode.Packages ? zoomPack : currentMode == mode.Particles ? zoom : clearZoom);

        filterL(!tr);
    }

    function paramTypeClick(d) {
        var g = d3.select(this);
        var tr = g.classed("checked");
        d3.select(this.parentNode)
                .selectAll(".fparam")
                .classed("checked", false);
        g.classed("checked", true);

        currentModeParam = modeParam[d];
        if (!tr) {
            vis.initColor();
            vis.filterMap.clear();
            root.values = initRootValues(data);
            filtersData[0].values = vis.color.domain().sort();
            filtersData[0].c = vis.color;
            initFilters(filtersData[0]);
            initCountiesPoints(root);
            applyMode(true);
        }
    }

    function baseTypeClick(d) {
        var g = d3.select(this);
        var tr = g.classed("checked");
        d3.select(this.parentNode)
                .selectAll(".fftitem")
                .classed("checked", false);
        g.classed("checked", true);

        currentModeBase = modeBase[d];
        if (!tr) {
            root.values = initRootValues(data);
            y.domain(root.values.map(function(d) { return d.key; }));
            svg.selectAll(".y.axis")
                .call(yAxis)
                .selectAll("text")
                .on("mouseover", fade(.1))
                .on("mouseout", fade(1))
                .attr("dy", '-.6em')
                .style("cursor", "pointer")
                .style("text-anchor", "end")
                .style("font-size", "8px")
            ;
            initCountiesPoints(root);
            applyMode(true);
        }
    }

    filtersData.forEach(initFilters);

    /**
     * Filter Functions on Hover
     */

    function filterC(selected) {
        countryPoints
                .style("opacity", .1)
                .filter(function(d) { return key(d) == selected.key; })
                .style("opacity", 1);

        title.text(selected.key);
    }

    function legFilter(d) {
        return d.type == 1 || (d.type == 2 && vis.filterMap.has(d.key)) || vis.filterMap.has(d[currentModeParam]);
    }

    function filterValue(d) {
        return legFilter(d) ? value(d) : 0;
    }

    function doStyle(d) {
        return legFilter(d) ? null : "none";
    }

    function filterL(selected) {
        pack.value(vis.filterMap.length > 0 ? filterValue : value)
                .sort(sort)
                .nodes(root, 0)
        ;

        countryPoints
                .style("display", doStyle);

        countryNames
                .style("display", doStyle);

        //title.text(selected);
        if (vis.filterMap.keys().length < 1)
            filterOff(selected);

        country.style("display", currentMode == mode.Chords || currentMode == mode.Sankeys ? "none" : null);


        applyMode(selected);
    }

    function filterOff(selected) {
        countryPoints
                .style("display", null);

        countryNames
                .style("display", null);

        title.text("");
    }

    var chm = d3.select(".legend.itemType.checked");
    modeClick.call(chm.node(), chm.datum());
});

var rsTimer;
function resize() {
    sb_w = sidebar.node().clientWidth || 215;
    chart.style("width", null);
    widthFull = (chart.node().clientWidth || 740) - sb_w;
    chart.style("width", widthFull + "px");

    sidebar.style("display", "none");

    heightFull = chart.node().clientHeight || 600;
    width = widthFull - margin.left - margin.right;
    height = heightFull - margin.top - margin.bottom;

    sidebar.style("display", null);
    var hs = height - sidebar.select("h1").node().clientHeight;
    sidebar.select("#filters")
        .attr("height", hs)
    ;

    chart.select("svg").attr("width", widthFull)
            .attr("height", heightFull);
    zl.attr("width", widthFull)
            .attr("height", heightFull);

    x.range([margin.top, width]).nice();
    y.rangeRoundBands([margin.top/2, height]);

    svg.selectAll(".x.axis")
            .call(xAxis.tickSize(-height))
            .attr("transform", "translate(0," + (height + 10) + ")")
            .selectAll(".label")
            .attr("dx", width + margin.right/2);

    svg.selectAll(".y.axis")
            .call(yAxis.tickSize(-width))
            .selectAll("text")
            .attr("dy", '-.6em')
    ;

    pack && root && pack.size([width + margin.left, height]).nodes(root);

    vis.tooltip
        .spaceWidth(width)
        .spaceHeight(height)
    ;

    applyMode();
}

// Resize behavior
d3.select(window).on("resize", function() {
    if (rsTimer)
        clearTimeout(rsTimer);
    rsTimer = setTimeout(resize, 300);
});

/**
 * Initialize a environment of visualisation
 * @return {{}}
 */
function initVis() {
    // Tooltip Helper from
    // https://gist.github.com/milroc/2975255
    d3.helper = {};

    d3.helper.tooltip = function(){
        var tooltipDiv,
            body = d3.select('body'),
            attrs = [],
            text = "",
            styles = [],
            _w, _h;

        function tooltip(selection) {

            function doText(d, i) {
                // Crop text arbitrarily
                tooltipDiv.html(
                    typeof text === "function"
                        ? text(d, i)
                        : typeof text != "undefined" || typeof text != null
                        ? text
                        : ''
                );
            }

            function mover(d, i) {

                var key, name, value;

                // Clean up lost tooltips
                body.selectAll('div.tooltip').remove();

                // Append tooltip
                tooltipDiv = body.append('div');

                for (key in attrs) {
                    if (!attrs.hasOwnProperty(key))
                        continue;
                    name = attrs[key][0];
                    if (typeof attrs[key][1] === "function") {
                        value = attrs[key][1](d, i);
                    } else value = attrs[key][1];
                    if (name === "class") value += " tooltip";
                    tooltipDiv.attr(name, value);
                }
                for (key in styles) {
                    if (!styles.hasOwnProperty(key))
                        continue;
                    name = styles[key][0];
                    if (typeof attrs[key][1] === "function") {
                        value = styles[key][1](d, i);
                    } else value = styles[key][1];
                    tooltipDiv.style(name, value);
                }
                tooltipDiv.style('position', 'absolute')
                        .style('z-index', 1001);
                mm(d, i);
                doText(d, i);
            }

            function mm(d, i) {
                // Move tooltip
                var absoluteMousePos = d3.mouse(body.node());


                tooltipDiv
                    .style('left', (absoluteMousePos[0] > _w/2
                        ? absoluteMousePos[0] - tooltipDiv.node().clientWidth - 15
                        : absoluteMousePos[0] + 15) + 'px')
                    .style('top', (absoluteMousePos[1] > _h/2
                        ? absoluteMousePos[1] - tooltipDiv.node().clientHeight + 15
                        : absoluteMousePos[1] - 15) + 'px');
                //doText(d, i);
            }

            function mout(d, i){
                // Remove tooltip
                tooltipDiv.remove();
            }

            selection
                    .on("mouseover.tooltip", mover)
                    .on('mousemove.tooltip', mm)
                    .on("mouseout.tooltip", mout);
        }

        tooltip.attr = function(name, value) {
            attrs.push(arguments);
            return tooltip;
        };

        tooltip.text = function(value) {
            text = value;
            return tooltip;
        };

        tooltip.style = function(name, value) {
            styles.push(arguments);
            return tooltip;
        };

        tooltip.spaceWidth = function(value) {
            if (!value) return _w;
            _w = +value;
            return tooltip;
        };

        tooltip.spaceHeight = function(value) {
            if (!value) return _h;
            _h = +value;
            return tooltip;
        };

        return tooltip;
    };

    d3.helper.mapExt = function(obj) {
        var _map = d3.map({}),
            map = {
                set : _set,
                remove : _remove,
                clear : clear,
                length : 0
            };

        function _set(key, value) {
            var r = _map.set(key, value);
            map.length = _map.keys().length;
            return r;
        }

        function _remove(key) {
            var r = _map.remove(key);
            map.length = _map.keys().length;
            return r;
        }

        function clear() {
            _map.keys().forEach(_remove);
        }

        ['has', 'get', 'keys', 'values', 'entries', 'forEach'].forEach(function(d) {
            map[d] = _map[d].bind(_map);
        });

        return map;
    };

    var baseData
        , countries = {}
        , countriesByIndex = {}
        , countriesCounter = 0
        , color
        , that
        ;

    var filterMap = d3.helper.mapExt({});

    /**
     * Initialisation Data
     */

    /** Data Structure:
     *  As of Date: "12/18/12 0:00"
        Borrower Contract Reference Number: "MWP-B2.5/2-6"
        Borrower Country: "Armenia"
        Borrower Country Code: "AM"
        Contract Description: "Procurement of vehicles"
        Contract Signing Date: "8/6/12 0:00"
        Fiscal Year: "2013"
        Major Sector: "Water, sanitation and flood protection"
        Procurement Category: "Goods"
        Procurement Method: "SHOP"
        Procurement Type: "Equipment, Transportation"
        Product line: "IBRD/IDA"
        Project ID: "P126722"
        Project Name: "MUNICIPAL WATER"
        Region: "EUROPE AND CENTRAL ASIA"
        Supplier: "GLOBAL MOTORS CJSC"
        Supplier Country: "Armenia"
        Supplier Country Code: "AM"
        Total Contract Amount (USD): "$40,995.00 "
        WB Contract Number: "1325908"
     */

    // return object country
    function initCounty(key, value) {
        var c = countries[key] || ( countries[key] = {
            key: key,
            name: value,
            shortName: value.split(',')[0],
            id: countriesCounter++,
            toString : function(full) {
                return full ? this.name : this.shortName;
            }
        });
        return countriesByIndex[c.id] = c;
    }

    function initProcurement(d) {
        return {
            category : d['Procurement Category'],
            method : d['Procurement Method'],
            type : d['Procurement Type']
        };
    }

    function initContract(d) {
        return {
            desc : d['Contract Description'],
            date : Date.parse(d['Contract Signing Date'])
        };
    }

    function initProject(d) {
        return {
            name : d['Project Name'],
            id : d['Project ID'],
            toString : function() {
                return this.name;
            }
        };
    }

    function check(d) {
        return filterMap.length < 1 || filterMap.has(d[currentModeParam]);
    }

    function value() {
        return check(this) ? this.basevalue : 0;
    }

    return that = {
        color : (color = d3.scale.category20()),
        initColor : function() {
            that.color = color = d3.scale.category20();
        },
        filterMap : filterMap,
        tooltip : d3.helper.tooltip()
            .attr("class", function(d, i) { return d[currentModeParam]; })
            .attr("d", "b")
            .text(function(d, i){
                return [
                    d.type != -1 ? currentModeBase == modeBase.Borrower ? "Borrower: <b>" : "Supplier: <b>" : "",
                    d.type == 1 ? d.key : d.type == 2 ? d.values[0][currentModeBase].name : !d.type ? d[currentModeBase].name : "",
                    !d.type ? "</b><br>" + (currentModeBase == modeBase.Borrower ? "Supplier: <b>" + d.supplier.name : "Borrower: <b>" + d.borrower.name) : "",
                    d.type == 2 || !d.type ? "</b><br>" + currentModeParam + ": <b>" : "",
                    d.type == 2 ? d.key : !d.type ? d[currentModeParam] : "",
                    !d.type ? "</b><br/>Project: <b>(" + d.project.id + ") " + d.project.name : "",
                    "</b><br/><br/>",
                    currentModeBase == modeBase.Borrower ? (!d.type ? "Supplied" : "Borrowed") : (d.type ? "Supplied" : "Borrowed"),
                    " ($): <b>",
                    th(d.value),
                    "M.</b><br>"
                ].join("");
        }),
        dataItem : function(d) {
            // Convert strings to numbers.
            d.value = d.basevalue = parseInt(d["Total Contract Amount (USD)"].substring(1));
            d.valueOf = value;

            d.borrower = initCounty(d["Borrower Country Code"], d["Borrower Country"]);
            d.supplier = initCounty(d["Supplier Country Code"], d["Supplier Country"]);
            d.sector = d["Major Sector"];
            d.product = d['Product line'];
            d.procurement = initProcurement(d);
            d.contract = initContract(d);
            d.year = d['Fiscal Year'];
            d.project = initProject(d);
            d.id = d['WB Contract Number'];
            d.date = Date.parse(d['As of Date']);

            return d;
        },
        chord : (function() {
            var that;

            var g, g1, g2, chords, groups, arc, chord, tcalc;

            var rad = 180 / Math.PI;

            var countriesCor = {}
                , countriesCorByIndex = {}
                , countriesCorCounter = 0
                , cells = {}
                , matrix = []
                , r0
                ;

            var tooltip = d3.helper.tooltip()
                .attr("class", function(d, i) { return d[currentModeParam]; })
                .attr("d", "b")
                .text(function(d, i){
                    var result = [];

                    if (d.hasOwnProperty("index")) {
                        result = [
                            "Country: <b>",
                            countriesCorByIndex[d.index].shortName,
                            "</b><br/><br/>" + (currentModeBase == modeBase.Borrower ? "Supplied" : "Borrowed") + " ($): <b>",
                            th(Math.floor(d.value)) + "M.</b><br/>"
                        ];
                    }
                    else {
                        d = d.source.value;
                        result = [
                            "Supplier: <b>",
                            d.supplier.shortName,
                            "</b><br/>Borrower: <b>",
                            d.borrower.shortName,
                            "</b><br/>" + currentModeParam + ": <b>",
                            d[currentModeParam],
                            "</b><br/>Number of projects: <b>",
                            d.values.length,
                            "</b><br/><br/>" + (currentModeBase == modeBase.Borrower ? "Supplied" : "Borrowed") + " ($): <b>",
                            th(+d),
                            "</b><br/>"

                        ];
                    }
                    return result.join("");
                })
            ;

            function initCor(d) {
                var c = countriesCor[d.key] || (countriesCor[d.key] = {
                    v : d,
                    id : countriesCorCounter++
                });
                countriesCorByIndex[c.id] = d;
                return c;
            }

            function filterChord(d) {
                var t = false,
                    n = d.source.value && d.source.value.values.length;
                while (--n > -1)
                    if (t = check(d.source.value.values[n]))
                        break;
                return t;
            }

            function valueBase() {
                var v = 0, n = this.values.length;
                if (filterMap.length > 0) {
                    while(--n > -1)
                        v += filterMap.has(this.values[n][currentModeParam]) ? this.values[n] : 0;
                }
                else {
                    v = this.basevalue;
                }
                return v;
            }

            function key(d) {
                return d[currentModeParam] + "s" + d.supplier.key + "b" + d.borrower.key;
            }

            function keyChord(d) {
                return key(d.source.value);
            }

            function initCell(d, k) {
                k = "s" + d.supplier.key + "b" + d.borrower.key;
                return cells[k] || (cells[k] = {
                    key : k,
                    supplier : d.supplier,
                    borrower : d.borrower,
                    basevalue : 0,
                    valueOf : valueBase,
                    hash : {},
                    values : []
                });
            }

            function appendValue(c, d) {
                var k = c.hash[d[currentModeParam]],
                    cell = c.values[k];
                if (!cell) {
                    cell = {
                        supplier : d.supplier,
                        borrower : d.borrower,
                        basevalue : 0,
                        valueOf : value,
                        values : []
                    };
                    cell[currentModeParam] = d[currentModeParam];
                    c.hash[d[currentModeParam]] = c.values.push(cell) - 1;
                }
                cell.basevalue += d.basevalue;
                cell.values.push(d);
                return cell;
            }

            function appendMatrix(d) {
                var c = initCor(currentModeBase == modeBase.Borrower ? d.supplier : d.borrower);
                var row = matrix[c.id];
                if (!row)
                    row = matrix[c.id] = [];
                c = row[initCor(currentModeBase == modeBase.Borrower ? d.borrower : d.supplier).id] = initCell(d);
                c.basevalue += d.basevalue;
                appendValue(c, d);
            }

            function fill(d) {
                return color(d.source.value[currentModeParam]);
            }

            function stroke(d) {
                return d3.rgb(fill(d)).darker();
            }

            function sortChord(a, b) {
                return d3.ascending((a.source.value + a.target.value) / 2, (b.source.value + b.target.value) / 2);
            }

            function sortGroups(a, b) {
                return d3.ascending(groupText(a), groupText(b));
            }

            function initChord(d) {
                var r = d.source.endAngle - d.source.startAngle
                    , m
                    , result = []
                    , l
                    , b
                    , lastAngle
                ;
                if (d.source.value) {
                    m = d3.sum(d.source.value.values);

                    lastAngle = d.source.startAngle;
                    l = d.source.value.values.length;

                    while(--l > -1) {
                        b = d.source.value.values[l];
                        if (!+b)
                            continue;
                        b = {
                            source : {
                                startAngle : lastAngle,
                                endAngle : (lastAngle += r * b/m),
                                index : d.source.index,
                                value : b
                            }
                        };
                        if (d.source == d.target)
                            b.target = b.source;
                        else
                            b.target = d.target;
                        result.push(b);
                    }
                }
                return result;
            }

            function addChord(g) {
                g.attr("class", "chord")
            }

            function updChord(g) {
                var m = g.selectAll("path.itemChord")
                    .data(initChord, keyChord);

                m.exit().remove();

                m.enter()
                    .append("path")
                    .on("mouseover", fadeChord(.1))
                    .on("mouseout", fadeChord(1))
                    .call(tooltip)
                    .attr("class", "itemChord")
                    .style("fill", fill)
                    .style("stroke", stroke)
                ;

                m.sort(sortChord)
                    .transition()
                    .duration(750)
                    .attr("d", chord)
                ;
            }

            function calcLength(d) {
                return displayLength(tcalc.text(d).node());
            }

            function groupStyle(d) {
                return (d.endAngle - d.startAngle) * (r0 - 20) * rad  > (calcLength(this.textContent) + 6) * rad ? null : 'hidden';
            }

            function groupText(d) {
                return countriesCorByIndex[d.index].shortName;
            }

            // Returns an event handler for fading a given chord group.
            function fade(opt) {
                return function(g, i) {
                    chords.selectAll("path")
                        .filter(function(d) { return d.source.index != i && d.target.index != i; })
                        .transition()
                        .style("opacity", opt);
                };
            }

            function fadeChord(opt) {
                return function(g) {
                    var sector = g.source.value[currentModeParam];

                    chords.selectAll("path")
                            .filter(function(d) { return d.source.value[currentModeParam] != sector; })
                            .transition()
                            .style("opacity", opt);
                };
            }

            function addGroup(g) {
                g.attr("class", "group")
                    .on("mouseover", fade(.1))
                    .on("mouseout", fade(1));

                // Add the group arc.
                g.append("path")
                    .style("fill", 'rgba(236, 246, 255, 1)')
                    .attr("id", function(d, i) {
                        return "group" + d.index + "-";
                    });

                // Add the group label (but only for large groups, where it will fit).
                // An alternative labeling mechanism would be nice for the small groups.
                g.append("text")
                    .attr("x", 6)
                    .attr("dy", '-.55em')
                    .append("textPath")
                        .attr("xlink:href", function(d) {
                            return "#group" + d.index + "-";
                        })
                        .text(groupText)
                ;
            }

            function updGroup(g) {
                g.selectAll("path")
                    .transition()
                    .duration(750)
                    .attr("d", arc)
                ;

                g.selectAll("text")
                    .style("visibility", groupStyle);
            }

            return that = {
                clear : function(data) {
                    g && g.remove();
                    g = g1 = g2 = chords = groups = tcalc = null;

                    for(var i in matrix)
                        if (matrix.hasOwnProperty(i))
                            matrix[i].splice(0, matrix.length);
                    matrix.splice(0, matrix.length);
                    cells = {};
                    return that;
                },
                initMatrix : function(data) {
                    data.forEach(appendMatrix);
                    return that;
                },
                draw : function(svg, layout, w, h) {
                    if (!g) {
                        var n = matrix.length;
                        for(var i = 0; i < n; i++){
                            var row = matrix[i];
                            if (!row)
                                row = matrix[i] = [];
                            for(var j = 0; j < n; j++) {
                                if (matrix[i][j] != undefined)
                                    continue;
                                matrix[i][j] = 0;
                            }
                        }
                    }

                    tooltip.spaceHeight(h).spaceWidth(w);

                    r0 = Math.min(w, h) / 2 - 4;
                    var r1 = r0 - 20;


                    // The arc generator, for the groups.
                    (arc || (arc = d3.svg.arc()))
                            .innerRadius(r0)
                            .outerRadius(r1);

                    // The chord generator (quadratic Bzier), for the chords.
                    (chord || (chord = d3.svg.chord()))
                            .radius(r0);

                    // Compute the chord layout.
                    layout.matrix(matrix);

                    layout.sortGroups(undefined);

                    (g || (g = svg.append("g")))
                            .attr("transform", "translate(" + [w/2, h/2 + margin.top] + ")");

                    g1 = g1 || g.append('g');
                    g2 = g2 || g.append('g');

                    tcalc = tcalc || g.append("text")
                            .style("opacity", 0)
                            .style("visibility", "hidden");

                    //g.selectAll("g.chord").remove();

                    // Add chords.
                    chords = g1.selectAll("g.chord")
                            .data(layout.chords().filter(filterChord), keyChord);

                    chords.exit().remove();

                    chords.enter()
                            .append("g")
                            .call(addChord)
                    ;

                    chords.call(updChord);

                    //g.selectAll("g.group").remove();

                    // Add groups.
                    groups = g2.selectAll("g.group")
                            .data(layout.groups(), function(d) {
                                return countriesCorByIndex[d.index].key;
                            });

                    groups.exit().remove();

                    groups.enter()
                            .append("g")
                            .call(addGroup)
                            .call(tooltip)
                    ;

                    groups.each(function(k) {
                        d3.select(this).selectAll("*")
                                .datum(k);
                    });

                    groups.call(updGroup);

                    return that;
                },
                show : function() {
                    g && g.style("display", null);
                    return that;
                },
                hide : function() {
                    g && g.style("display", "none");
                    return that;
                }
            };
        })(),
        sankey : (function(){
            var that;

            var typeLink = {
                    ss: 0, // supplier - sector
                    sb: 1, // borrower - sector
                    bp: 2  // sector - project
                },
                typeNode = {
                    c : '_c_',
                    cb : '_cb_',
                    s : '_s_',
                    p : '_p_'
                }
            ;


            var nodes = d3.helper.mapExt({}),
                links = [];

            var _layout;

            var tooltip = d3.helper.tooltip()
                .attr("class", function(d, i) { return 't'; })
                .attr("d", "b")
                .text(function(d){
                    var result = [];

                    if (d.hasOwnProperty("nodeValue")) {
                        result = [
                            d.type == typeNode.c || d.type == typeNode.cb
                                ? "Country "
                                : d.type == typeNode.s
                                ? "Sector "
                                : "Project ",
                            ":  <b>",
                            d.nodeValue.toString(),
                            d.type == typeNode.p ? "</b><br/>ID: <b>" + d.nodeValue.id : "",
                            "</b></br><br/>",
                            d.type == typeNode.c
                                ? "Supplied "
                                : d.type == typeNode.cb
                                ? "Borrowed "
                                : "Money ",
                            "($): <b>",
                            th(Math.floor(d.value)),
                            "M.</b><br/>"
                        ];
                    }
                    else {
                        result = [
                            "Supplier: <b>",
                            d.linkValue.supplier.shortName,
                            "</b><br/>Borrower: <b>",
                            d.linkValue.borrower.shortName,
                            "</b><br/>" + currentModeParam + ": <b>",
                            d.linkValue[currentModeParam],
                            "</b><br/>Project: <b>",
                            "(" + d.linkValue.project.id + ") ",
                            d.linkValue.project.name,
                            "</b><br/><br/>Supplied ($): <b>",
                            th(d.value()),
                            "M.</b><br/>"
                        ];
                    }
                    return result.join("");
                })
            ;

            function appendNode(d, key, type) {
                var node = nodes.get(key);
                if (!node) {
                    nodes.set(key, node = {
                        type : type,
                        key : key,
                        nodeValue : d
                    });
                }
                return node;
            }

            function appendLinks(d) {
                var f = value.bind(d);

                links.push({
                    source : appendNode(d.supplier, typeNode.c + d.supplier.key, typeNode.c),
                    target : appendNode(d[currentModeParam], typeNode.s + d[currentModeParam], typeNode.s),
                    type : typeLink.ss,
                    value : f,
                    linkValue : d
                });

                links.push({
                    source : appendNode(d[currentModeParam], typeNode.s + d[currentModeParam], typeNode.s),
                    target : appendNode(d.borrower, typeNode.cb + d.borrower.key, typeNode.cb),
                    type : typeLink.sb,
                    value : f,
                    linkValue : d
                });

                links.push({
                    source : appendNode(d.borrower, typeNode.cb + d.borrower.key, typeNode.cb),
                    target : appendNode(d.project, typeNode.p + d.project.id, typeNode.p),
                    type : typeLink.bp,
                    value : f,
                    linkValue : d
                });
            }

            function dragMove(d) {
                d3.select(this)
                    .attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
                _layout.relayout();
                link.attr("d", path);
            }

            function checkByType(l, n) {
                var type = n.type;
                return type == typeNode.cb
                        ? l.linkValue.borrower.key != n.nodeValue.key
                        : type == typeNode.c
                        ? l.linkValue.supplier.key != n.nodeValue.key
                        : type == typeNode.s
                        ? l.linkValue[currentModeParam] != n.nodeValue
                        : l.linkValue.project.id != n.nodeValue.id;
            }

            function fadeNode(opt) {
                return function(n) {
                    var nh = {};

                    link.filter(function(l) {
                            var ch = checkByType(l, n);
                            !ch
                            && (nh[l.source.key] = true)
                            && (nh[l.target.key] = true);
                            return ch;
                        })
                        .transition()
                        .style("opacity", opt)
                    ;

                    node.filter(function(l) {
                            return !nh.hasOwnProperty(l.key);
                        })
                        .transition()
                        .style("opacity", opt)
                    ;
                }
            }

            function fadeLink(opt) {
                return function(l) {
                    var nh = {};
                    nh[l.source.key] = true;
                    nh[l.target.key] = true;

                    link.filter(function(ls) {
                        var ch = ls.linkValue != l.linkValue;
                        !ch
                        && (nh[ls.source.key] = true)
                        && (nh[ls.target.key] = true);
                        return ch;
                    })
                    .transition()
                    .style("opacity", opt);

                    node.filter(function(n) {
                        return !nh.hasOwnProperty(n.key);
                    })
                    .transition()
                    .style("opacity", opt);
                }
            }

            var g, g1, g2,
                node, link, path;

            return that = {
                clear : function() {
                    g && g.remove();
                    g = g1 = g2 = node = link = path = null;
                    links.splice(0, links.length);
                    nodes.clear();
                    return that;
                },
                initLinks : function(values) {
                    values.forEach(appendLinks);
                    return that;
                },
                draw : function(svg, layout, w, h) {

                    var workNodes = d3.map({}),
                        workLinks = links.filter(function(d) {
                            var r =  d.value() > 0;
                            r = r && ((filterMap.length > 0 && filterMap.length < 3) || d.type != typeLink.bp);
                            if (r) {
                                if (!workNodes.has(d.source.key))
                                    workNodes.set(d.source.key, d.source);
                                if (!workNodes.has(d.target.key))
                                    workNodes.set(d.target.key, d.target);
                            }
                            return r;
                        });

                    (_layout = layout || _layout || d3.sankey().nodeWidth(8).nodePadding(4))
                        .links(workLinks)
                        .nodes(workNodes.values())
                        .size([w, h - margin.top/2])
                        .layout(32)
                    ;

                    tooltip.spaceHeight(h).spaceWidth(w);

                    path = path || _layout.link();
                    (g || (g = svg.append("g").attr("class", "sankey")))
                        .attr('transform', 'translate(' + [margin.right/3, margin.top/2] + ')');
                    g1 = g1 || g.append("g");
                    g2 = g2 || g.append("g");

                    g1.selectAll(".link").remove();

                    link = g1.selectAll(".link")
                        .data(_layout.links());

                    link.enter()
                        .append("path")
                        .call(tooltip)
                        .attr("class", "link")
                        .on("mouseover", fadeLink(.2))
                        .on("mouseout", fadeLink(1))
                    ;

                    link.attr("d", path)
                        .style('stroke', function(d) {
                            return color(d.linkValue[currentModeParam]);
                        })
                        .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                        .sort(function(a, b) { return b.dy - a.dy; })
                    ;

                    g2.selectAll(".node").remove();

                    node = g2.selectAll(".node")
                        .data(_layout.nodes(), function(d) {
                            return d.key;
                        })
                    ;

                    node.enter()
                        .append("g")
                        .attr("class", "node")
                        .call(tooltip)
                        .on("mouseover", fadeNode(.2))
                        .on("mouseout", fadeNode(1))
                        .call(d3.behavior.drag()
                            .origin(function(d) { return d; })
                            .on("dragstart", function() { this.parentNode.appendChild(this); })
                            .on("drag", dragMove))
                        .call(function(g) {
                            g.append("rect")
                                .style("fill", function(d) {
                                    return d.color = d.type == typeNode.c || d.type == typeNode.cb
                                        ? 'rgba(236, 246, 255, 1)'
                                        : d.type == typeNode.p
                                        ? 'rgba(246, 236, 255, 1)'
                                        : color(d.nodeValue);
                                })
                                .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
                            ;

                            g.append("text")
                                .attr("x", -6)
                                .attr("dy", ".35em")
                                .attr("text-anchor", "end")
                                .attr("transform", null)
                                .text(function(d) { return d.nodeValue.toString(); })
                                .filter(function(d) { return d.x < w / 2; })
                                .attr("x", 6 + _layout.nodeWidth())
                                .attr("text-anchor", "start")
                            ;
                        })
                    ;

                    node.attr("transform", function(d) {
                        var y = d.y + (d.dy < 0 ? d.dy : 0);
                        return "translate(" + [d.x , y] + ")";
                    });

                    node.selectAll('rect')
                        .attr("height", function(d) { return Math.abs(d.dy); })
                        .attr("width", _layout.nodeWidth())
                    ;

                    node.selectAll("text")
                        .attr("y", function(d) { return Math.abs(d.dy) / 2; })
                        .style("display", function(d) { return Math.abs(d.dy) < 16  ? "none" : null })
                    ;
                    return that;
                },
                show : function() {
                    g && g.style("display", null);
                    return that;
                },
                hide : function() {
                    g && g.style("display", "none");
                    return that;
                }
            }
        })()
    };
}

</script><!-- ********************************************************************* version code ends ** -->

</body>
</html>
